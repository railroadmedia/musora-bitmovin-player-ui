name: CI

on: 
  push:
    branches:
      - '**'

  workflow_dispatch:

  workflow_call:

jobs:
  verify-changelog:
    outputs:
      HAS_CHANGELOG: ${{ steps.ensure-changelog.outputs.HAS_CHANGELOG }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure Changelog
        shell: bash
        run: |
          git config --global user.name 'Automated Release'
          git config --global user.email 'release-automation@bitmovin.com'
          git fetch origin develop
          changes=$(git diff --name-only origin/develop...origin/feature/fix-release)
          if echo $changes | grep -q CHANGELOG.md; then
            echo "CHANGELOG.md has been updated"
            echo "HAS_CHANGELOG=true" >> $GITHUB_OUTPUT
          else
            echo "CHANGELOG.md has not been updated, skipping release"
          fi

  test_and_build:
    runs-on: ubuntu-latest

    steps:
        # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Cache node modules
        id: cache-nodemodules
        uses: actions/cache@v4
        env:
          cache-name: cache-node-modules
        with:
          path: node_modules
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        if: steps.cache-nodemodules.outputs.cache-hit != 'true'
        run: npm ci

      - name: Test
        run: npm test

      - name: Build and prepare for a potential 'npm publish'
        run: gulp npm-prepare

      - name: Package artifact for upload
        run: tar -czvf artifact.tar.gz dist
        shell: bash

      - uses: actions/upload-artifact@v4
        with:
          path: |
            ${{ github.workspace }}/artifact.tar.gz
          if-no-files-found: error
          retention-days: 1

