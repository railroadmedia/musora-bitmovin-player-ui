<!doctype html>
<html lang="en">
  <head>
    <title>Text To Speech Test Page</title>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bitmovin Player -->
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/bitmovinplayer.js"></script>
    <script
      type="text/javascript"
      src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-advertising-bitmovin.js"
    ></script>

    <!-- UI -->
    <script src="js/bitmovinplayer-ui.js"></script>
    <link rel="stylesheet" href="css/bitmovinplayer-ui.css" />

    <style>
      .player-wrapper {
        width: 95%;
        margin: 20px auto;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
      }

      #caption-toggle-button {
        font-size: 1em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="content">
        <a href="index.html"><- Back to playground</a>
        <div class="player-wrapper">
          <div id="player" autofocus></div>
          <!-- The autofocus attribute is required by some platforms to allow Text To Speech to work -->
        </div>
      </div>
    </div>
    <script type="text/javascript">
      window.onload = function () {
        const APP_ID = 'com.bitmovin.demo.webapp';
        const PLAYER_KEY = '7b49d26a-8609-45ad-96a0-46c22240cef2'; // daniel.weinberger@bitmovin.com

        var videoSegmentNumber = 0;

        const conf = new bitmovin.player.util.PlayerConfigBuilder(PLAYER_KEY)
          .optimizeForPlatform({ appId: APP_ID })
          .mergeWith({
            playback: {
              muted: true,
            },
            adaptation: {
              onVideoAdaptation: function (data, b, c) {
                return data.representations.sort(function (a, b) {
                  return b.bandwidth - a.bandwidth;
                })[0].id;
              },
            },
            network: {
              preprocessHttpResponse: function (type, response) {
                if (type === 'media/video') {
                  videoSegmentNumber++;

                  var p;

                  if (videoSegmentNumber > 3) {
                    p = new Promise(function (resolve) {
                      setTimeout(function () {
                        resolve(response);
                      }, 9000);
                    });
                  } else {
                    p = Promise.resolve(response);
                  }

                  return p;
                }
                return Promise.resolve(response);
              },
            },
            tweaks: {
              restart_threshold: 5,
            },
            advertising: {},
            ui: false,
          })
          .build();

        var source = {
          dash: 'https://bitmovin.com',
          // dash: "https://bitmovin-a.akamaihd.net/content/sintel/sintel.mpd",
          // hls: "https://cdn.bitmovin.com/content/assets/sintel/hls/playlist.m3u8",
          poster: 'https://cdn.bitmovin.com/content/assets/sintel/poster.png',
        };

        bitmovin.player.Player.addModule(bitmovin.player['advertising-bitmovin'].default);

        var container = document.getElementById('player');
        player = new bitmovin.player.Player(container, conf);
        var uiManager = new bitmovin.playerui.UIManager(player, [buildCustomAdsTvUi(), buildCustomTvUi()], {});

        player.load(source).then(function () {
          // player.ads.schedule({
          //   tag: {
          //     url:
          //       "https://pubads.g.doubleclick.net/gampad/ads?iu=/21775744923/external/single_preroll_skippable&sz=640x480&ciu_szs=300x250%2C728x90&gdfp_req=1&output=vast&unviewed_position_start=1&env=vp&impl=s&correlator=" +
          //       Math.random(),
          //     type: "vast",
          //   },
          //   position: "pre",
          // });
        });

        player.on(bitmovin.player.PlayerEvent.Warning, function (data) {
          console.log('Warning Event: ' + JSON.stringify(data));
        });

        player.on(bitmovin.player.PlayerEvent.Error, function (data) {
          console.log('Error Event: ' + JSON.stringify(data));
        });
      };

      function buildCustomTvUi() {
        const interval = 15;

        const subtitleListBox = new bitmovin.playerui.SubtitleListBox();
        const subtitleListPanel = new bitmovin.playerui.SettingsPanel({
          components: [
            new bitmovin.playerui.SettingsPanelPage({
              components: [new bitmovin.playerui.SettingsPanelItem(null, subtitleListBox)],
            }),
          ],
          hidden: true,
        });

        const audioTrackListBox = new bitmovin.playerui.AudioTrackListBox();
        const audioTrackListPanel = new bitmovin.playerui.SettingsPanel({
          components: [
            new bitmovin.playerui.SettingsPanelPage({
              components: [new bitmovin.playerui.SettingsPanelItem(null, audioTrackListBox)],
            }),
          ],
          hidden: true,
        });

        const playbackToggleButton = new bitmovin.playerui.PlaybackToggleButton({
          onAriaLabel: 'Pause',
          offAriaLabel: 'Stop',
        });
        const volumeMuteButton = new bitmovin.playerui.VolumeToggleButton({
          onAriaLabel: 'Unmute audio',
          offAriaLabel: 'Mute audio',
        });

        const rewindButton = new bitmovin.playerui.QuickSeekButton({
          seekSeconds: -interval,
          hideInLivePlayback: true,
        });

        const forwardButton = new bitmovin.playerui.QuickSeekButton({
          seekSeconds: interval,
          hideInLivePlayback: true,
        });

        const captionToggleButton = new bitmovin.playerui.ToggleButton({
          id: 'caption-toggle-button',
          cssClass: 'ui-subtitlesettingstogglebutton',
          text: 'CC',
          onAriaLabel: 'Disable closed captions',
          offAriaLabel: 'Enable closed captions',
        });
        captionToggleButton.onClick.subscribe(function (e) {
          if (captionToggleButton.isOn()) {
            captionToggleButton.off();
            player.subtitles
              .list()
              .filter(function (sub) {
                return sub.enabled;
              })
              .forEach(function (sub) {
                player.subtitles.disable(sub.id);
              });
            console.log('subtitles disabled');
          } else {
            if (player.subtitles.list().length > 0) {
              captionToggleButton.on();
              player.subtitles.enable(player.subtitles.list()[0].id);
              console.log('subtitles enabled');
            } else {
              console.warn('no subtitles available to enable');
            }
          }
        });

        const fullscreenButton = new bitmovin.playerui.FullscreenToggleButton({
          onAriaLabel: 'Exit fullscreen',
          offAriaLabel: 'Enter fullscreen',
        });

        const seekBar = new bitmovin.playerui.SeekBar({
          label: new bitmovin.playerui.SeekBarLabel(),
          ariaFallbackMode: true,
        });

        const subtitleToggleButton = new bitmovin.playerui.SettingsToggleButton({
          settingsPanel: subtitleListPanel,
          autoHideWhenNoActiveSettings: true,
          cssClass: 'ui-subtitlesettingstogglebutton',
          text: bitmovin.playerui.i18n.getLocalizer('settings.subtitles'),
          ariaLabel: bitmovin.playerui.i18n.getLocalizer('settings.subtitles'),
        });
        const audioToggleButton = new bitmovin.playerui.SettingsToggleButton({
          settingsPanel: audioTrackListPanel,
          autoHideWhenNoActiveSettings: true,
          cssClass: 'ui-audiotracksettingstogglebutton',
          text: bitmovin.playerui.i18n.getLocalizer('settings.audio.track'),
          ariaLabel: bitmovin.playerui.i18n.getLocalizer('settings.audio.track'),
        });
        const uiContainer = new bitmovin.playerui.UIContainer({
          components: [
            new bitmovin.playerui.SubtitleOverlay(),
            new bitmovin.playerui.BufferingOverlay(),
            // playbackToggleOverlay,
            new bitmovin.playerui.ControlBar({
              components: [
                new bitmovin.playerui.Container({
                  components: [
                    new bitmovin.playerui.PlaybackTimeLabel({
                      timeLabelMode: bitmovin.playerui.PlaybackTimeLabelMode.CurrentTime,
                      hideInLivePlayback: true,
                    }),
                    seekBar,
                    new bitmovin.playerui.PlaybackTimeLabel({
                      timeLabelMode: bitmovin.playerui.PlaybackTimeLabelMode.RemainingTime,
                      cssClasses: ['text-right'],
                    }),
                  ],
                  cssClasses: ['controlbar-top'],
                }),
                new bitmovin.playerui.Container({
                  components: [
                    playbackToggleButton,
                    rewindButton,
                    forwardButton,
                    volumeMuteButton,
                    captionToggleButton,
                    new bitmovin.playerui.Spacer(),
                    fullscreenButton,
                  ],
                  cssClasses: ['controlbar-bottom'],
                }),
              ],
            }),
            new bitmovin.playerui.TitleBar({
              components: [
                new bitmovin.playerui.Container({
                  components: [
                    new bitmovin.playerui.MetadataLabel({
                      content: bitmovin.playerui.MetadataLabelContent.Title,
                    }),
                    subtitleToggleButton,
                    audioToggleButton,
                  ],
                  cssClasses: ['ui-titlebar-top'],
                }),
                new bitmovin.playerui.Container({
                  components: [
                    new bitmovin.playerui.MetadataLabel({
                      content: bitmovin.playerui.MetadataLabelContent.Description,
                    }),
                    subtitleListPanel,
                    audioTrackListPanel,
                  ],
                  cssClasses: ['ui-titlebar-bottom'],
                }),
              ],
            }),
            new bitmovin.playerui.RecommendationOverlay(),
            new bitmovin.playerui.ErrorMessageOverlay(),
          ],
          cssClasses: ['ui-skin-tv'],
          hideDelay: 2000,
          hidePlayerStateExceptions: [
            bitmovin.playerui.PlayerUtils.PlayerState.Prepared,
            bitmovin.playerui.PlayerUtils.PlayerState.Paused,
            bitmovin.playerui.PlayerUtils.PlayerState.Finished,
          ],
        });

        const spatialNavigation = new bitmovin.playerui.SpatialNavigation(
          new bitmovin.playerui.RootNavigationGroup(
            uiContainer,
            playbackToggleButton,
            rewindButton,
            forwardButton,
            volumeMuteButton,
            captionToggleButton,
            fullscreenButton,
            seekBar,
            audioToggleButton,
            subtitleToggleButton,
          ),
          new bitmovin.playerui.ListNavigationGroup(
            bitmovin.playerui.ListOrientation.Vertical,
            subtitleListPanel,
            subtitleListBox,
          ),
          new bitmovin.playerui.ListNavigationGroup(
            bitmovin.playerui.ListOrientation.Vertical,
            audioTrackListPanel,
            audioTrackListBox,
          ),
        );

        return {
          ui: uiContainer,
          spatialNavigation: spatialNavigation,
          condition: function (context) {
            return !context.isAd;
          },
        };
      }

      function buildCustomAdsTvUi() {
        const playbackToggleButton = new bitmovin.playerui.PlaybackToggleButton();
        const fullscreenBtn = new bitmovin.playerui.FullscreenToggleButton();

        const skipAdButton = new bitmovin.playerui.AdSkipButton();
        const skipAdContainer = new bitmovin.playerui.Container({
          components: [
            new bitmovin.playerui.AdMessageLabel({ text: bitmovin.playerui.i18n.getLocalizer('ads.remainingTime') }),
            skipAdButton,
          ],
          cssClass: 'ui-ads-status',
          cssClasses: ['ui-ads-status', 'ui-skin-ads'],
        });

        const uiContainer = new bitmovin.playerui.UIContainer({
          components: [
            new bitmovin.playerui.ControlBar({
              components: [
                new bitmovin.playerui.Container({
                  components: [playbackToggleButton],
                  cssClasses: ['controlbar-bottom'],
                }),
              ],
            }),
            new bitmovin.playerui.TitleBar({
              components: [
                new bitmovin.playerui.Container({
                  components: [skipAdContainer],
                  cssClasses: ['controlbar-top'],
                }),
              ],
            }),
          ],
          cssClasses: ['ui-skin-tv', 'ui-skin-ads'],
          hideDelay: 5000,
          hidePlayerStateExceptions: [
            bitmovin.playerui.PlayerUtils.PlayerState.Prepared,
            bitmovin.playerui.PlayerUtils.PlayerState.Paused,
            bitmovin.playerui.PlayerUtils.PlayerState.Finished,
          ],
        });

        const spatialNavigation = new bitmovin.playerui.SpatialNavigation(
          new bitmovin.playerui.RootNavigationGroup(uiContainer, playbackToggleButton, skipAdContainer),
        );

        return {
          ui: uiContainer,
          spatialNavigation: spatialNavigation,
          condition: function (context) {
            return context.isAd;
          },
        };
      }
    </script>
  </body>
</html>
